---
# Tasks for Remediation role

- name: Create a virtual environment for Remediation script
  ansible.builtin.shell:
    cmd: "python3 -m venv {{ role_path }}/venv"
  args:
    creates: "{{ role_path }}/venv"
  changed_when: false
  tags:
    - remediation

- name: Install dependencies in virtual environment
  ansible.builtin.shell:
    cmd: "{{ role_path }}/venv/bin/pip install -r {{ role_path }}/files/requirements.txt"
  changed_when: false
  tags:
    - remediation

- name: Set environment variables for Remediation script
  ansible.builtin.set_fact:
    instana_env:
      BASE_URL: "{{ base_url }}"
      APPLICATION_ID: "{{ application_id | default('') }}"
      TOKEN: "{{ instana_api_token }}"
      AWX_EXECUTION: "true"
      INCIDENT_ID: "{{ incident_id | default('') }}"
  tags:
    - remediation

- name: Ensure the Remediation script has execute permissions
  ansible.builtin.file:
    path: "{{ role_path }}/files/remediation_trigger.py"
    mode: '0755'
  tags:
    - remediation

- name: Create artifacts directory
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../artifacts"
    state: directory
    mode: '0755'
  tags:
    - remediation

- name: Run Remediation script with virtual environment
  ansible.builtin.shell:
    cmd: "{{ role_path }}/venv/bin/python {{ role_path }}/files/remediation_trigger.py"
  args:
    executable: /bin/bash
  environment: "{{ instana_env }}"
  register: remediation_script_output
  changed_when: false
  ignore_errors: true

  timeout: 900
  tags:
    - remediation

- name: Check if output JSON file exists
  ansible.builtin.stat:
    path: "{{ role_path }}/files/remediation_output.json"
  register: remediation_json_file
  tags:
    - remediation

- name: Read Remediation JSON output
  ansible.builtin.slurp:
    src: "{{ role_path }}/files/remediation_output.json"
  register: remediation_json_content
  when: remediation_json_file.stat.exists
  tags:
    - remediation

- name: Set Remediation data as fact
  ansible.builtin.set_fact:
    remediation_data: "{{ remediation_json_content.content | b64decode | from_json if remediation_json_file.stat.exists else {'status': 'error', 'message': 'Remediation output file not found'} }}"
  tags:
    - remediation

- name: Create fallback Remediation data if script failed
  ansible.builtin.set_fact:
    remediation_data: "{{ {'status': 'error', 'message': 'Remediation script execution failed', 'error': remediation_script_output.stderr | default('Unknown error')} }}"
  when: remediation_script_output.rc is defined and remediation_script_output.rc != 0
  tags:
    - remediation

- name: Debug Remediation data (pretty print)
  debug:
    msg: "{{ remediation_data | to_nice_json }}"
  tags:
    - remediation

- name: Set job artifact
  ansible.builtin.set_stats:
    data:
      remediation_data: "{{ remediation_data }}"
    per_host: false
  tags:
    - remediation


